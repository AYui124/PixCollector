{% extends "base.html" %}

{% block title %}系统配置 - PixCollector{% endblock %}

{% block content %}
<style>
    .config-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border: 1px solid #f3f4f6;
    }
    
    .icon-box {
        border-radius: 9999px;
        padding: 0.5rem;
        margin-right: 0.75rem;
    }
    
    .config-input {
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.75rem;
        transition: all 0.2s;
    }
    
    .config-input:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .save-button {
        width: 100%;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 500;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        border: none;
    }
    
    .save-button:hover {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: translateY(-0.125rem);
    }
    
    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .cron-tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
    }

    .cron-tooltip .tooltip-text {
        visibility: hidden;
        width: 320px;
        background-color: #374151;
        color: #fff;
        text-align: left;
        border-radius: 0.5rem;
        padding: 0.75rem;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.875rem;
        line-height: 1.5;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .cron-tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #374151 transparent transparent transparent;
    }

    .cron-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    .tooltip-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #f3f4f6;
    }

    .tooltip-examples {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .tooltip-example {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid #4b5563;
    }

    .tooltip-example:last-child {
        border-bottom: none;
    }

    .tooltip-example-code {
        font-family: 'Courier New', monospace;
        background: #1f2937;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.8125rem;
    }

    .tooltip-example-desc {
        color: #d1d5db;
    }

    .info-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.25rem;
        height: 1.25rem;
        background: #e0e7ff;
        color: #4f46e5;
        border-radius: 50%;
        margin-left: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        vertical-align: middle;
    }

    .key-table {
        width: 100%;
        border-collapse: collapse;
    }

    .key-table th {
        text-align: left;
        padding: 0.75rem 1rem;
        border-bottom: 2px solid #e5e7eb;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
    }

    .key-table td {
        padding: 1rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .key-table tr:hover {
        background: #f9fafb;
    }

    .key-value {
        font-family: 'Courier New', monospace;
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-active {
        background: #d1fae5;
        color: #065f46;
    }

    .status-inactive {
        background: #fee2e2;
        color: #991b1b;
    }

    .action-button {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }

    .action-button:hover {
        transform: translateY(-0.0625rem);
    }

    .delete-button {
        background: #fee2e2;
        color: #991b1b;
    }

    .delete-button:hover {
        background: #fecaca;
    }

    .toggle-button {
        background: #dbeafe;
        color: #1e40af;
    }

    .toggle-button:hover {
        background: #bfdbfe;
    }
</style>

<div style="margin-bottom: 1.5rem; max-width: 140rem; margin-left: auto; margin-right: auto; padding: 0 1rem;">
    <!-- 页面标题 -->
    <div style="margin-bottom: 2rem;">
        <h1 class="title is-3">系统配置</h1>
        <p class="subtitle is-6 has-text-grey mt-3">管理系统各项配置参数</p>
    </div>

    <!-- 上半部分：3:4布局 -->
    <div class="columns is-multiline" style="margin-bottom: 0rem;">
        <!-- 左侧：Pixiv Token配置 + 采集配置 -->
        <div class="column is-12-mobile is-5-desktop" style="margin-bottom: 1.5rem;">
            <!-- Pixiv Token配置 -->
            <div class="config-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                <div class="section-title">
                    <div class="icon-box has-background-blue-light">
                        <svg class="image is-20x20" style="color: #2563eb;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L10 14H9v1H8v1H7v-4h4v1H8v2h1v1h1l-.343 1.257A6 6 0 0115 17v-2a2 2 0 012-2zM9 9l-3 3 3 3m-3-3h12" />
                        </svg>
                    </div>
                    <h2 class="title is-5 has-text-grey-darker">Pixiv Token配置</h2>
                </div>

                <div class="mb-5">
                    <div class="field">
                        <label for="refresh-token" class="label is-small has-text-weight-medium mb-2">Refresh Token</label>
                        <input type="password" id="refresh-token" placeholder="输入refresh_token"
                            class="input config-input">
                        <p class="help mt-1 is-small has-text-grey-light">必需：用于获取access_token</p>
                    </div>

                    <div class="field">
                        <label for="access-token" class="label is-small has-text-weight-medium mb-2">Access Token（可选）</label>
                        <input type="password" id="access-token" placeholder="输入access_token或留空自动获取"
                            class="input config-input">
                        <p class="help mt-1 is-small has-text-grey-light">可选：如果提供则直接使用，否则通过refresh_token获取</p>
                    </div>

                    <div class="columns is-mobile">
                        <div class="column">
                            <button onclick="saveTokens(event)" class="save-button" style="background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%); color: white;">
                                保存Token
                            </button>
                        </div>
                        <div class="column">
                            <button onclick="testConnection(event)" class="save-button" style="background: white; border: 1px solid #d1d5db; color: #374151;">
                                测试连接
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 采集配置 -->
            <div class="config-card" style="padding: 1.5rem; margin-bottom: 0rem;">
                <div class="section-title">
                    <div class="icon-box has-background-success-light">
                        <svg class="image is-20x20" style="color: #059669;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3 2.286 6.857z" />
                        </svg>
                    </div>
                    <h2 class="title is-5 has-text-grey-darker">采集配置</h2>
                </div>

                <div class="mb-5">
                    <div class="columns is-mobile">
                        <div class="column">
                            <label for="update-interval" class="label is-small has-text-weight-medium mb-2">更新间隔（天）</label>
                            <input type="number" id="update-interval" min="1" max="365" value="30"
                                class="input config-input">
                            <p class="help mt-1 is-small has-text-grey-light">更新间隔多久天内发布的作品元数据</p>
                        </div>
                        <div class="column">
                            <label for="update-max-per-run" class="label is-small has-text-weight-medium mb-2">每次更新最大处理数</label>
                            <input type="number" id="update-max-per-run" min="1" max="1000" value="200"
                                class="input config-input">
                            <p class="help mt-1 is-small has-text-grey-light">每次更新任务最多处理的作品数量</p>
                        </div>
                    </div>

                    <div class="field">
                        <label for="invalid-action" class="label is-small has-text-weight-medium mb-2">失效作品处理</label>
                        <div class="select is-fullwidth">
                            <select id="invalid-action" class="config-input">
                                <option value="mark">标记为失效</option>
                                <option value="delete">删除</option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <label for="backtrack-years" class="label is-small has-text-weight-medium mb-2">新用户回采年数</label>
                        <input type="number" id="backtrack-years" min="0" max="10" value="2"
                            class="input config-input">
                        <p class="help mt-1 is-small has-text-grey-light">新关注用户回采多少年的作品</p>
                    </div>

                    <div class="field">
                        <label for="log-retention-days" class="label is-small has-text-weight-medium mb-2">日志保留天数</label>
                        <input type="number" id="log-retention-days" min="1" max="365" value="30"
                            class="input config-input">
                        <p class="help mt-1 is-small has-text-grey-light">采集日志保留多少天</p>
                    </div>

                    <div class="field">
                        <label for="ranking-collect-pages" class="label is-small has-text-weight-medium mb-2">排行榜采集页数</label>
                        <input type="number" id="ranking-collect-pages" min="1" max="10" value="5"
                            class="input config-input">
                        <p class="help mt-1 is-small has-text-grey-light">每个排行榜采集多少页</p>
                    </div>

                    <div class="field">
                        <label for="custom-ranking-keywords" class="label is-small has-text-weight-medium mb-2">自定义榜单关键词</label>
                        <input type="text" id="custom-ranking-keywords" placeholder="" class="input config-input">
                        <p class="help mt-1 is-small has-text-grey-light">多个关键词用逗号分隔，系统将依次搜索每个关键词</p>
                    </div>

                    <button onclick="saveConfig(event)" class="save-button" style="background: linear-gradient(90deg, #059669 0%, #047857 100%); color: white;">
                        保存采集配置
                    </button>
                </div>
            </div>
        </div>

        <!-- 右侧：定时任务配置 + 速率限制配置 -->
        <div class="column is-12-mobile is-7-desktop">
            <!-- 定时任务配置 -->
            <div class="config-card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                <div class="section-title">
                    <div class="icon-box has-background-cyan-light">
                        <svg class="image is-20x20" style="color: #0891b2;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="title is-5 has-text-grey-darker">定时任务配置</h2>
                </div>

                <div class="mb-5">
                    <div class="field">
                        <label class="label is-small has-text-weight-medium mb-2">
                            自定标签排行采集
                            <span class="cron-tooltip">
                                <span class="info-icon">?</span>
                                <span class="tooltip-text">
                                    <div class="tooltip-title">Cron表达式格式：分 时 日 月 周</div>
                                    <div class="tooltip-examples">
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * *</span>
                                            <span class="tooltip-example-desc">每天凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 */2 * * *</span>
                                            <span class="tooltip-example-desc">每2小时</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1</span>
                                            <span class="tooltip-example-desc">每周一凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 1 * *</span>
                                            <span class="tooltip-example-desc">每月1号凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1-5</span>
                                            <span class="tooltip-example-desc">工作日（周一到五）凌晨2点</span>
                                        </div>
                                    </div>
                                </span>
                            </span>
                        </label>
                        <div class="columns">
                            <div class="column is-8">
                                <label class="label is-small has-text-grey-light mb-1">Cron表达式</label>
                                <input type="text" id="artwork_ranking-cron" value="0 0 2 * * *" placeholder="秒 分 时 日 月 周"
                                    class="input config-input">
                            </div>
                            <div class="column is-4">
                                <label class="label is-small has-text-grey-light mb-1">状态</label>
                                <div class="select is-fullwidth">
                                    <select id="artwork_ranking-active" class="config-input">
                                        <option value="true">启用</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label is-small has-text-weight-medium mb-2">
                            同步关注列表
                            <span class="cron-tooltip">
                                <span class="info-icon">?</span>
                                <span class="tooltip-text">
                                    <div class="tooltip-title">Cron表达式格式：分 时 日 月 周</div>
                                    <div class="tooltip-examples">
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * *</span>
                                            <span class="tooltip-example-desc">每天凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 */2 * * *</span>
                                            <span class="tooltip-example-desc">每2小时</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1</span>
                                            <span class="tooltip-example-desc">每周一凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 1 * *</span>
                                            <span class="tooltip-example-desc">每月1号凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1-5</span>
                                            <span class="tooltip-example-desc">工作日（周一到五）凌晨2点</span>
                                        </div>
                                    </div>
                                </span>
                            </span>
                        </label>
                        <div class="columns">
                            <div class="column is-8">
                                <label class="label is-small has-text-grey-light mb-1">Cron表达式</label>
                                <input type="text" id="follow-sync-cron" value="0 0 6 * * *" placeholder="秒 分 时 日 月 周"
                                    class="input config-input">
                            </div>
                            <div class="column is-4">
                                <label class="label is-small has-text-grey-light mb-1">状态</label>
                                <div class="select is-fullwidth">
                                    <select id="follow-sync-active" class="config-input">
                                        <option value="true">启用</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label is-small has-text-weight-medium mb-2">
                            采集关注用户新作品
                            <span class="cron-tooltip">
                                <span class="info-icon">?</span>
                                <span class="tooltip-text">
                                    <div class="tooltip-title">Cron表达式格式：分 时 日 月 周</div>
                                    <div class="tooltip-examples">
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * *</span>
                                            <span class="tooltip-example-desc">每天凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 */2 * * *</span>
                                            <span class="tooltip-example-desc">每2小时</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1</span>
                                            <span class="tooltip-example-desc">每周一凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 1 * *</span>
                                            <span class="tooltip-example-desc">每月1号凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1-5</span>
                                            <span class="tooltip-example-desc">工作日（周一到五）凌晨2点</span>
                                        </div>
                                    </div>
                                </span>
                            </span>
                        </label>
                        <div class="columns">
                            <div class="column is-8">
                                <label class="label is-small has-text-grey-light mb-1">Cron表达式</label>
                                <input type="text" id="follow-works-cron" value="0 */2 * * * *" placeholder="秒 分 时 日 月 周"
                                    class="input config-input">
                            </div>
                            <div class="column is-4">
                                <label class="label is-small has-text-grey-light mb-1">状态</label>
                                <div class="select is-fullwidth">
                                    <select id="follow-works-active" class="config-input">
                                        <option value="true">启用</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label is-small has-text-weight-medium mb-2">
                            更新作品元数据
                            <span class="cron-tooltip">
                                <span class="info-icon">?</span>
                                <span class="tooltip-text">
                                    <div class="tooltip-title">Cron表达式格式：分 时 日 月 周</div>
                                    <div class="tooltip-examples">
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * *</span>
                                            <span class="tooltip-example-desc">每天凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 */2 * * *</span>
                                            <span class="tooltip-example-desc">每2小时</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1</span>
                                            <span class="tooltip-example-desc">每周一凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 1 * *</span>
                                            <span class="tooltip-example-desc">每月1号凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1-5</span>
                                            <span class="tooltip-example-desc">工作日（周一到五）凌晨2点</span>
                                        </div>
                                    </div>
                                </span>
                            </span>
                        </label>
                        <div class="columns">
                            <div class="column is-8">
                                <label class="label is-small has-text-grey-light mb-1">Cron表达式</label>
                                <input type="text" id="update-works-cron" value="0 0 3 * * *" placeholder="秒 分 时 日 月 周"
                                    class="input config-input">
                            </div>
                            <div class="column is-4">
                                <label class="label is-small has-text-grey-light mb-1">状态</label>
                                <div class="select is-fullwidth">
                                    <select id="update-works-active" class="config-input">
                                        <option value="true">启用</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field">
                        <label class="label is-small has-text-weight-medium mb-2">
                            清理旧日志
                            <span class="cron-tooltip">
                                <span class="info-icon">?</span>
                                <span class="tooltip-text">
                                    <div class="tooltip-title">Cron表达式格式：分 时 日 月 周</div>
                                    <div class="tooltip-examples">
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * *</span>
                                            <span class="tooltip-example-desc">每天凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 */2 * * *</span>
                                            <span class="tooltip-example-desc">每2小时</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1</span>
                                            <span class="tooltip-example-desc">每周一凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 1 * *</span>
                                            <span class="tooltip-example-desc">每月1号凌晨2点</span>
                                        </div>
                                        <div class="tooltip-example">
                                            <span class="tooltip-example-code">0 2 * * 1-5</span>
                                            <span class="tooltip-example-desc">工作日（周一到五）凌晨2点</span>
                                        </div>
                                    </div>
                                </span>
                            </span>
                        </label>
                        <div class="columns">
                            <div class="column is-8">
                                <label class="label is-small has-text-grey-light mb-1">Cron表达式</label>
                                <input type="text" id="clean-up-logs-cron" value="0 0 4 * * *" placeholder="秒 分 时 日 月 周"
                                    class="input config-input">
                            </div>
                            <div class="column is-4">
                                <label class="label is-small has-text-grey-light mb-1">状态</label>
                                <div class="select is-fullwidth">
                                    <select id="clean-up-logs-active" class="config-input">
                                        <option value="true">启用</option>
                                        <option value="false">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveSchedulerConfig(event)" class="save-button" style="background: linear-gradient(90deg, #0891b2 0%, #0e7490 100%); color: white;">
                        保存任务配置
                    </button>
                </div>
            </div>

            <!-- 速率限制配置 -->
            <div class="config-card" style="padding: 1.5rem; margin-bottom: 0rem;">
                <div class="section-title">
                    <div class="icon-box has-background-purple-light">
                        <svg class="image is-20x20" style="color: #9333ea;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h2 class="title is-5 has-text-grey-darker">速率限制配置</h2>
                </div>

                <div class="mb-5">
                    <div class="columns is-multiline">
                        <div class="column is-6-desktop">
                            <div class="field">
                                <label class="label is-small has-text-weight-medium mb-2">API调用延迟（秒）</label>
                                <div class="columns is-mobile">
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最小</label>
                                        <input type="number" id="api-delay-min" step="0.1" value="1.0" placeholder="最小"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最大</label>
                                        <input type="number" id="api-delay-max" step="0.1" value="3.0" placeholder="最大"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label is-small has-text-weight-medium mb-2">429错误延迟（秒）</label>
                                <div class="columns is-mobile">
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最小</label>
                                        <input type="number" id="error-delay-429-min" step="0.1" value="30.0" placeholder="最小"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最大</label>
                                        <input type="number" id="error-delay-429-max" step="0.1" value="60.0" placeholder="最大"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="column is-6-desktop">
                            <div class="field">
                                <label class="label is-small has-text-weight-medium mb-2">403错误延迟（秒）</label>
                                <div class="columns is-mobile">
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最小</label>
                                        <input type="number" id="error-delay-403-min" step="0.1" value="60.0" placeholder="最小"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最大</label>
                                        <input type="number" id="error-delay-403-max" step="0.1" value="120.0" placeholder="最大"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label is-small has-text-weight-medium mb-2">其他错误延迟（秒）</label>
                                <div class="columns is-mobile">
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最小</label>
                                        <input type="number" id="error-delay-other-min" step="0.1" value="10.0" placeholder="最小"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                    <div class="column">
                                        <label class="label is-small has-text-grey-light mb-1">最大</label>
                                        <input type="number" id="error-delay-other-max" step="0.1" value="20.0" placeholder="最大"
                                            class="input config-input" style="padding: 0.5rem 0.75rem;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="saveConfig(event)" class="save-button" style="background: linear-gradient(90deg, #9333ea 0%, #7c3aed 100%); color: white;">
                        保存速率配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 下半部分：API密钥管理（100%宽度） -->
    <div class="columns is-multiline">
        <div class="column is-12">
            <!-- API密钥管理 -->
            <div class="config-card" style="padding: 1.5rem;">
                <div class="section-title">
                    <div class="icon-box has-background-orange-light">
                        <svg class="image is-20x20" style="color: #ea580c;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L10 14H9v1H8v1H7v-4h4v1H8v2h1v1h1l-.343 1.257A6 6 0 0115 17v-2a2 2 0 012-2zM9 9l-3 3 3 3m-3-3h12" />
                        </svg>
                    </div>
                    <h2 class="title is-5 has-text-grey-darker">API密钥管理</h2>
                </div>

                <div class="mb-5">
                    <div class="field" style="margin-bottom: 1.5rem;">
                        <label for="new-key-name" class="label is-small has-text-weight-medium mb-2">创建新密钥</label>
                        <div class="columns">
                            <div class="column is-8">
                                <input type="text" id="new-key-name" placeholder="输入密钥名称（如：移动端应用、第三方集成等）"
                                    class="input config-input">
                            </div>
                            <div class="column is-4">
                                <button onclick="createApiKey(event)" class="save-button" style="background: linear-gradient(90deg, #ea580c 0%, #dc6803 100%); color: white;">
                                    创建密钥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-5">
                    <div style="margin-bottom: 1rem;">
                        <label class="label is-small has-text-weight-medium mb-2">密钥列表</label>
                    </div>
                    <div id="keys-container">
                        <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                            加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建密钥成功模态框 -->
    <div id="key-modal" class="modal">
        <div class="modal-background" onclick="closeModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">密钥创建成功</p>
                <button class="delete" aria-label="close" onclick="closeModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="notification is-warning">
                    请立即复制并保存您的密钥，关闭此窗口后将无法再次查看完整密钥！
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="label">密钥名称</label>
                    <div id="modal-key-name" style="font-weight: 600;"></div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="label">API密钥</label>
                    <div id="modal-key-value" class="key-value" style="font-size: 1rem; padding: 0.5rem 1rem; word-break: break-all;"></div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button onclick="copyKey()" class="button is-info is-fullwidth">
                        复制密钥
                    </button>
                </div>
            </section>
            <footer class="modal-card-foot" style="justify-content: flex-end;margin-top: 0;padding: 10px;">
                <button class="button" onclick="closeModal()">关闭</button>
            </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 通用按钮加载状态管理函数
function setButtonLoading(button, isLoading) {
    const originalText = button.getAttribute('data-original-text');
    
    if (isLoading) {
        // 保存原始文本
        if (!originalText) {
            button.setAttribute('data-original-text', button.innerHTML);
        }
        
        // 设置加载状态
        button.disabled = true;
        button.innerHTML = `
            <span class="animate__animated animate__spin" style="display: inline-flex; align-items: center;">
                <svg style="width: 1rem; height: 1rem;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </span>
        `;
    } else {
        // 恢复原始状态
        button.disabled = false;
        button.innerHTML = originalText || button.getAttribute('data-original-text');
        button.removeAttribute('data-original-text');
    }
}

async function loadConfig() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        if (data.success) {
            const config = data.config;
            document.getElementById('update-interval').value = config.update_interval_days || 30;
            document.getElementById('update-max-per-run').value = config.update_max_per_run || 200;
            document.getElementById('invalid-action').value = config.invalid_artwork_action || 'mark';
            document.getElementById('backtrack-years').value = config.new_user_backtrack_years || 2;
            
            document.getElementById('api-delay-min').value = config.api_delay_min || 1.0;
            document.getElementById('api-delay-max').value = config.api_delay_max || 3.0;
            document.getElementById('error-delay-429-min').value = config.error_delay_429_min || 30.0;
            document.getElementById('error-delay-429-max').value = config.error_delay_429_max || 60.0;
            document.getElementById('error-delay-403-min').value = config.error_delay_403_min || 60.0;
            document.getElementById('error-delay-403-max').value = config.error_delay_403_max || 120.0;
            document.getElementById('error-delay-other-min').value = config.error_delay_other_min || 10.0;
            document.getElementById('error-delay-other-max').value = config.error_delay_other_max || 20.0;
            document.getElementById('log-retention-days').value = config.log_retention_days || 30;
            document.getElementById('access-token').value = config.access_token || '';
            document.getElementById('refresh-token').value = config.refresh_token || '';
            document.getElementById('ranking-collect-pages').value = config.ranking_collect_pages || 5;
            document.getElementById('custom-ranking-keywords').value = config.custom_ranking_keywords || '';
        }
    } catch (error) {
        console.error('加载配置失败:', error);
        notify('加载配置失败', 'error');
    }
}

async function loadSchedulerConfig() {
    try {
        const response = await fetch('/api/config/scheduler');
        const data = await response.json();
        if (data.success) {
            data.configs.forEach(config => {
                if (config.collect_type === 'ranking_works') {
                    document.getElementById('artwork_ranking-cron').value = config.crontab_expression;
                    document.getElementById('artwork_ranking-active').value = config.is_active;
                } else if (config.collect_type === 'follow_new_follow') {
                    document.getElementById('follow-sync-cron').value = config.crontab_expression;
                    document.getElementById('follow-sync-active').value = config.is_active;
                } else if (config.collect_type === 'follow_new_works') {
                    document.getElementById('follow-works-cron').value = config.crontab_expression;
                    document.getElementById('follow-works-active').value = config.is_active;
                } else if (config.collect_type === 'update_artworks') {
                    document.getElementById('update-works-cron').value = config.crontab_expression;
                    document.getElementById('update-works-active').value = config.is_active;
                } else if (config.collect_type === 'clean_up_logs') {
                    document.getElementById('clean-up-logs-cron').value = config.crontab_expression;
                    document.getElementById('clean-up-logs-active').value = config.is_active;
                }
            });
        }
    } catch (error) {
        console.error('加载任务配置失败:', error);
        notify('加载任务配置失败', 'error');
    }
}

async function saveTokens(event) {
    const button = event.currentTarget;
    const refreshToken = document.getElementById('refresh-token').value;
    const accessToken = document.getElementById('access-token').value;

    if (!refreshToken) {
        notify('请输入refresh_token', 'warning');
        return;
    }

    setButtonLoading(button, true);
    
    try {
        const response = await fetch('/api/config/tokens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                refresh_token: refreshToken,
                access_token: accessToken || null
            })
        });
        const data = await response.json();
        if (data.success) {
            notify('Token保存成功', 'success');
        } else {
            notify('保存失败: ' + data.message, 'error');
        }
    } catch (error) {
        notify('保存失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function testConnection(event) {
    const button = event.currentTarget;
    
    setButtonLoading(button, true);
    
    try {
        const response = await fetch('/api/config/test', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            notify('连接测试成功: ' + data.message, 'success');
        } else {
            notify('连接测试失败: ' + data.message, 'error');
        }
    } catch (error) {
        notify('连接测试失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function saveConfig(event) {
    const button = event.currentTarget;
    const config = {
        update_interval_days: parseInt(document.getElementById('update-interval').value),
        update_max_per_run: parseInt(document.getElementById('update-max-per-run').value),
        invalid_artwork_action: document.getElementById('invalid-action').value,
        new_user_backtrack_years: parseInt(document.getElementById('backtrack-years').value),
        api_delay_min: parseFloat(document.getElementById('api-delay-min').value),
        api_delay_max: parseFloat(document.getElementById('api-delay-max').value),
        error_delay_429_min: parseFloat(document.getElementById('error-delay-429-min').value),
        error_delay_429_max: parseFloat(document.getElementById('error-delay-429-max').value),
        error_delay_403_min: parseFloat(document.getElementById('error-delay-403-min').value),
        error_delay_403_max: parseFloat(document.getElementById('error-delay-403-max').value),
        error_delay_other_min: parseFloat(document.getElementById('error-delay-other-min').value),
        error_delay_other_max: parseFloat(document.getElementById('error-delay-other-max').value),
        log_retention_days: parseInt(document.getElementById('log-retention-days').value),
        ranking_collect_pages: parseInt(document.getElementById('ranking-collect-pages').value),
        custom_ranking_keywords: document.getElementById('custom-ranking-keywords').value
    };

    setButtonLoading(button, true);
    
    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const data = await response.json();
        if (data.success) {
            notify('配置保存成功', 'success');
        } else {
            notify('保存失败: ' + data.message, 'error');
        }
    } catch (error) {
        notify('保存失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function saveSchedulerConfig(event) {
    const button = event.currentTarget;
    const config = {
        ranking_works: {
            crontab_expression: document.getElementById('artwork_ranking-cron').value,
            is_active: document.getElementById('artwork_ranking-active').value === 'true'
        },
        follow_new_follow: {
            crontab_expression: document.getElementById('follow-sync-cron').value,
            is_active: document.getElementById('follow-sync-active').value === 'true'
        },
        follow_new_works: {
            crontab_expression: document.getElementById('follow-works-cron').value,
            is_active: document.getElementById('follow-works-active').value === 'true'
        },
        update_artworks: {
            crontab_expression: document.getElementById('update-works-cron').value,
            is_active: document.getElementById('update-works-active').value === 'true'
        },
        clean_up_logs: {
            crontab_expression: document.getElementById('clean-up-logs-cron').value,
            is_active: document.getElementById('clean-up-logs-active').value === 'true'
        }
    };

    setButtonLoading(button, true);
    
    try {
        // 保存配置到数据库
        const response = await fetch('/api/config/scheduler', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const data = await response.json();
        if (!data.success) {
            notify('保存失败: ' + data.message, 'error');
            return;
        }
        notify('任务配置保存成功', 'success');
    } catch (error) {
        notify('保存失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

// 页面加载时获取配置
loadConfig();
loadSchedulerConfig();
loadApiKeys();


// API密钥管理相关函数
let createdKeyValue = '';

async function loadApiKeys() {
    try {
        const response = await fetch('/api/config/keys');
        const data = await response.json();
        
        if (data.success) {
            renderApiKeys(data.api_keys);
        } else {
            document.getElementById('keys-container').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444;">
                    加载失败: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        console.error('加载API密钥失败:', error);
        document.getElementById('keys-container').innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                加载失败: ${error.message}
            </div>
        `;
    }
}

function renderApiKeys(keys) {
    const container = document.getElementById('keys-container');
    
    if (keys.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #9ca3af;">
                <svg style="width: 4rem; height: 4rem; margin-bottom: 1rem; opacity: 0.5;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L10 14H9v1H8v1H7v-4h4v1H8v2h1v1h1l-.343 1.257A6 6 0 0115 17v-2a2 2 0 012-2zM9 9l-3 3 3 3m-3-3h12" />
                </svg>
                <p>暂无API密钥</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;">点击上方创建密钥开始使用</p>
            </div>
        `;
        return;
    }

    const table = document.createElement('table');
    table.className = 'key-table';
    
    table.innerHTML = `
        <thead>
            <tr>
                <th style="width: 20%;">名称</th>
                <th style="width: 25%;">密钥</th>
                <th style="width: 10%;">状态</th>
                <th style="width: 15%;">使用次数</th>
                <th style="width: 30%;">操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    keys.forEach(key => {
        const tr = document.createElement('tr');
        
        // 掩码显示密钥
        const maskedKey = key.key.substring(0, 8) + '...' + key.key.substring(key.key.length - 4);
        
        tr.innerHTML = `
            <td style="font-weight: 500;">${key.name}</td>
            <td><span class="key-value">${maskedKey}</span></td>
            <td>
                <span class="status-badge ${key.is_active ? 'status-active' : 'status-inactive'}">
                    ${key.is_active ? '启用' : '禁用'}
                </span>
            </td>
            <td>${key.usage_count} 次</td>
            <td>
                <button onclick="toggleKeyStatus(${key.id}, event)" class="action-button toggle-button">
                    ${key.is_active ? '禁用' : '启用'}
                </button>
                <button onclick="deleteKey(${key.id}, event)" class="action-button delete-button" style="margin-left: 0.5rem;">
                    删除
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
    
    container.innerHTML = '';
    container.appendChild(table);
}

async function createApiKey(event) {
    const button = event.currentTarget;
    const name = document.getElementById('new-key-name').value.trim();
    
    if (!name) {
        notify('请输入密钥名称', 'warning');
        return;
    }
    
    setButtonLoading(button, true);
    
    try {
        const response = await fetch('/api/config/keys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('new-key-name').value = '';
            showKeyModal(data.api_key);
            loadApiKeys();
            notify('密钥创建成功', 'success');
        } else {
            notify('创建失败: ' + data.message, 'error');
        }
    } catch (error) {
        notify('创建失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function deleteKey(keyId, event) {
    if (!confirm('确定要删除此API密钥吗？此操作不可恢复！')) {
        return;
    }
    
    const button = event.currentTarget;
    const originalText = button.innerHTML;
    setButtonLoading(button, true);
    
    try {
        const response = await fetch(`/api/config/keys/${keyId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            loadApiKeys();
            notify('密钥已删除', 'success');
        } else {
            notify('删除失败: ' + data.message, 'error');
        }
    } catch (error) {
        notify('删除失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
        button.innerHTML = originalText;
    }
}

async function toggleKeyStatus(keyId, event) {
    const button = event.currentTarget;
    const originalText = button.innerHTML;
    setButtonLoading(button, true);
    
    try {
        const response = await fetch(`/api/config/keys/${keyId}/toggle`, {
            method: 'PUT'
        });
        const data = await response.json();
        
        if (data.success) {
            loadApiKeys();
            notify('状态已更新', 'success');
        } else {
            notify('更新失败: ' + data.message, 'error');
        }
    } catch (error) {
        notify('更新失败: ' + error.message, 'error');
    } finally {
        setButtonLoading(button, false);
        button.innerHTML = originalText;
    }
}

function showKeyModal(apiKey) {
    createdKeyValue = apiKey.key;
    document.getElementById('modal-key-name').textContent = apiKey.name;
    document.getElementById('modal-key-value').textContent = apiKey.key;
    document.getElementById('key-modal').classList.add('is-active');
}

function closeModal() {
    document.getElementById('key-modal').classList.remove('is-active');
    createdKeyValue = '';
}

function copyKey() {
    if (createdKeyValue) {
        navigator.clipboard.writeText(createdKeyValue).then(() => {
            notify('密钥已复制到剪贴板', 'success');
        }).catch(err => {
            notify('复制失败: ' + err.message, 'error');
        });
    }
}
</script>
{% endblock %}